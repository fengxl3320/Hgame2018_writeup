#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <pthread.h>
#include <iostream>
#include <string>
#include "liba/MetaString.h"
#include "liba/ObfuscatedCall.h"
#include "liba/ObfuscatedCallWithPredicate.h"
#include <string.h>
#include <fcntl.h>
#include <jpeglib.h>

using namespace std;
using namespace andrivet::ADVobfuscator;
void play_music() {
    //auto notify = DEF_OBFUSCATED("notify-send -u critical waifu \"have fun~\" -i $PWD/omake/waifu.jpg");
    auto a = DEF_OBFUSCATED("while(true) do aplay ./omake/bgm.wav 2> /dev/null;done");
    string b = a.decrypt();
    //string notify_s = notify.decrypt();
    //system(notify_s.c_str());
    system(b.c_str());
    exit(0);
}



int IsDebuggerPresent(void)
{
    char buf[1024];
    int debugger_present = 0;

    int status_fd = open("/proc/self/status", O_RDONLY);
    if (status_fd == -1)
        return 0;

    ssize_t num_read = read(status_fd, buf, sizeof(buf)-1);

    if (num_read > 0)
    {
        static const char TracerPid[] = "TracerPid:";
        char *tracer_pid;

        buf[num_read] = 0;
        tracer_pid    = strstr(buf, TracerPid);
        if (tracer_pid)
            debugger_present = !!atoi(tracer_pid + sizeof(TracerPid) - 1);
    }

    return debugger_present;
}

string banner = "\
                                                `..--------------------:::---------------......----.`-//s+o++ss:+oy+:os+sso+oo/..```                  \n\
                 `..`   .`.`.-/:-.`        ``--------------------:--:::------------......-...-----:/oso+/+ossooyyyyso+o+so+:oo:-....```               \n\
      `  `````.-:o+/-.`.-+++ossos+:`    `.---......---------------------------...................--://ossosyssss/::/ooo:/++o+/:-........```           \n\
    ``     `:/+oo/+o++-:+oosssosoo/.```--..........------------------...---........................--/++++oo+/o+/syys+yo:+s/-.........`````````       \n\
   ```` ```:++oso+oo+os/ooossooo+so+.-::-..............-------..........-............................--:://+:+ys+/ys+////o+:-..```....````````````    \n\
  `...` ``.+++ooss++oyys+/+ss+o+osyo::-.....................---....................................-..---:::/::oo/+oooo/ss:-:.``    `..```````````````\n\
  `...`   .+:osoosso/--/osy+++++ooo/:...............................................................-------::+ooossssso+//+/--..`     `..````````` ```\n\
 `....` ``:oo++ooooossoo+/o+osso++:-..................................................................-----:::/osssso+++oo/-.......`    ...``....```` \n\
 `.....``.-:/+o//osysooososs//+/::-............................................----....................-:---:::///++oooo+:..........`   `............`\n\
 ``..........-/:oosoo/o+s+os+:/------........................................--::::::--..................-::::::::----:--............  ``----....---..\n\
```...........+/+++ossso++++/+:-:::-...................-----.................-------::::--................-:::::::-....--...........` `..------..-----\n\
````````......:+oosoossoo+:yo/:::--..................-:::---....................--------:::-..........``...-:::::-:-....--.........``....-------------\n\
``````........-/++o+osss++ss/::::--................--:---...............-...`......--------::---.......``....-:::-::-....--.......``.......-----------\n\
`````...```....---:::///+o+::::::-...............-:---........`.........-..-.........--...---::--........``.`.-::-:::-....--................----------\n\
````..`  `..............-:::::::................-:-..........`........`.-..-...........-.....--::-.```.``.``.`.-:::::::-......................--------\n\
```.`   `...............-:::::-................---..........`..`......`.-.`...............`....--:-..``.`..``...-::::::::-----.................-------\n\
```.``  `...............::::::................--.......................-.`.......................-:-..``.`...`...-:::::::::::-....................----\n\
````..```.........``...---:::................--....`.......`.....`...`.-.`..````..```````.-.....`.---..`.``...`.``--:::::::-::-......................-\n\
.````...``.......``...---:::-...............--............``..``.`````.-``..````.-.```````.--``.```-:-..`.``...`..`.-::::::::::-......................\n\
...````..........`...--::::-..............`.-.`..``````.```..```..````..`..```.``-.````````.:.``.```--...`.`......`..::::::::::--....``...............\n\
....````...........---:::::.``.............-.`..````````..`..``..````..`...```.``.-.````````--.`..```----``.`........--::::--:::-....````.............\n\
.....``..........---:-::-:-``.....`......`--`...```````..``.```.-````..`..````-.`.:-````````.--.`..```---.`.`.........--::::..:::-...```  ............\n\
.....``.........---:::::::.``..`..`...```.-.`..````````..`..```-.```..`..`````-.``--.````````-:-..-```.-.-.`...........-::::-`-::-...```` ``.......```\n\
................--:::::::-``..``.``..```.-.`..`````````-.`..`..-.``..`..``````--``.--````````.-:-.-.```.---..........-..-::::.`.::-..````  ````...````\n\
..............--:::::::::.`..```.`..````.-``..````````.-``.....-.`..`.-.``````--``..-.```````.--:..-````-.--`........--..-:::- `.:-..````   ````...```\n\
...........`.--::-::::::.``..`````.`````-.`..`````````-.`.-`.---...`.-.```````-.``...-.```````--:-.-...`..--.`........-...::::`  .--.````  `````....``\n\
..........``---::::::::-``..`````.`````.-.`..````.```.-``.-`.----..--.```````.-.``.....```````.-----.``..--:.`........-:..-:::.   `-..``` `.````.....`\n\
........` `----:-::-::-.`.-````````.```--``..```..``.-.``--.---...-..````````...``..`.-```````.-.-.--````.---```.......:-..::--`   `..``  `.```......`\n\
.......` `----::::::-:.`.-.`.``````````-.`..```.-``.--``.--..-...-..````````...```..``.-``````.....--.```..--.`........-:-.-:::.     ``` `..```...`..-\n\
......  `----:-::::::-..:-...`.```````.-.`..``.-.``.-.``.--....--.``````````..````..```-.`````......-.```..--.`..`......:-..-::-`    ````..`````.----:\n\
``..`  `.---::::::-::..--.....````````.-``..``.-.`.--``.--.....-.``````````..` ```..   ..`````......-.```..--.`.-.......::-.-:-:`     ``...````.------\n\
````  `.----::::::::-`-:.......`````.`--``..``.-``-..``....-..`-.``````````.`` ``..`  `.-.``........-.```..--.`.-.`.....-::..--:-    ``...```.-:::----\n\
``   `.--:-:::--.-:-..::.......````..`-.``..``.-.....`...-...` ..`````````..`  ``..````.--``..ooo:o+/.......-.`.-.`.....-:--.-:::`  ``...``.::::-::---\n\
`  `...--:-::-:..::-`-:-`......````..`-.``..``.-.......--....``.-```````...`  ``..` `.:.:/```/hhy/yys-..-.---.`.-.`.....-:-:..:-:-``.....` `.-:::-----\n\
  `....-:-:::-.`-::..::........```.-.`-.``.-``.--......--...-...-``````...`   `..` `:+/.::``.yhhyoo+o...-.:o-.`-.```....-:::-.::::......`    `--::----\n\
``....--:-:--. .::-.-:-.........``.-.`-.``.-``.-...--`-+syyyy+oo-.`````..`    ..`  `-`..``..+hhhyyys+`.----/.`.-.````...:::::.-:-:-.....       .-::---\n\
`....-:::-::.``-::..::-....`....`..-.`-.``.-.`.-:osyo./hhhys+os:.-.````.``   ..`     `.--:./yyhyyyyy-.:--...``-.`````...:::::--::-.....`        `.-:--\n\
....--:::::.  .:::.-::-..-.........-.`--``.-.`-soyhhy.+hhhysosso...```..`  ````      ...s+/yyyyyyyh/:s/.....`..``````..-:::::-.::.....`           `-:-\n\
...---:::-.  `-::-.-::-..-.......`-:.`--``.--`..-:./y:/hyyyyyysy:...``..` ``        ````-sosyyysyyso+/`....`...``````..-::::::-:-....`              .:\n\
...-:-::-`  `.:::-.:-:-..-........-:.`--.`.:--..`  .+o/yyyyyyyss+`.```..             `  `/sooooo+ooo:`.``..`.``````...-:-:::-:--....-.               `\n\
---:--:-`   .::-:--:-:...-........-:.`.:.`..-:..`.+ssysyyyysyyoo/`````..               ```/sssssoss+``.`..````````..-.-::::::::.....:-.               \n\
------```  `-::-:.-:-:...:........-:.`.:-.`..-..``-syssyysssooo/.```` `.`            ``````........``....````````..-.-:::::::::....---:`              \n\
----.`  ```-:::::-::--.`-:........-:..`---`.....` `./ssooo++++oo-````  ``           ````````.............```````..--.:::::::::-...-::---`             \n\
-:-`     `--:::::-:::-`.::-`.......:..`.--.`....`````./osoo+/::-``````              ```````..............``````..--.:::::::::-....-::-.--`            \n\
-.      `-:::::::::-:..-::-........:-.....--.-..```````.--.....`````````      ``    ``````............-.`````.-.-:.::-::::-::-...-::::-`--`           \n\
       `-:--:-::::::..-::::....-.`.::--..-.----..``````..........````````           ```````..........-.`````.--::--::::::::::....-:::-:.`--`          \n\
      `--:--:-::-::--::::-:-....-`.::::-....--:-..````.`..........````````           ``````````......-`````.-:::::::::::::::-....::::::-. .-`         \n\
     `--:..---::---:::::::::-...-..-::::-......--..``.............```````             `````````...`...````.-::::::::::::::::.....:::::::-` .-`        \n\
    .---.`-:::----:::::::::::...--.-:::::-.---..---.``...........````````             `````````````..```.-:::::::::::::::::-.....::::::::-  `-.       \n\
  `.-:-``-::::::::::::::::::::-..-..:::::-:--::-:::-.````.....``````````            ```    ````````..`..-::-:::::::::::::::-.....:::::::-:.  `..      \n\
 `---.` .:---:-::::::::::::::::-.--.-::::::--::::----.`````````````````` `````                  `..-...-::::::::::::::::::::-`...-::::::::-`   .-`    \n\
.---.  `------:-:::::::::::::::::-:-.::::::::::::::-:--.`````````````                        ``..-::-.-:::::::-:::::::::::::-``.`-:::::::::-`   .-`   \n\
---`  `-----:-:--::::::-::::::::::::--:::::::::::::::-:--.```````                          ``.-----::-::::--:::::::::::::::::.``..-:::::::::-`   `-`  \n\
-.    -------:---::::::::::::::::::::--:-::::::::::::::::---..````                      ``..-------::::::---:::::::::::::::::-````.-:::::::::-`   `.. \n\
`    .----------:-:::::::::::::::::::::-:::::::::::::::::::::-----..````             ``..--....-..--::::---::::::::-----::::::-` ``.:::::::::--`   `..\n\
    .----------::-:::::::::::::::::::::::::::::::::::::::::::::----.........````` ``..-............-:::----:::-.--......--:::::-` ``.-:::::::-:-`    .\n\
   .-----------::--:::::::::::::::::::::::::::::::::::::::::---....................................-::--.--::-.--.........-:::::-`   .-::::::----`    \n\
  `--------------:--:::-::::::::::::::::::::::::::::::::---.......................................--::-..-::-.--............-::::-.   `-::-:------`   \n\
 `---...---.------::::--:::::::::::::::::--------------...``````````..............``.............--:-:-..-::---...```````....::::::-`  `.--------:-`  \n\
`--.....--..-------::--::::::::::::::::-..````````````..``````````````...........................--.--...-:::-..```````````..-::::::-.`  .---:------. \n\
-......--..------------::::::::::::::-.`````````````````````.`````````````....`.```..`........``...`-....:::-.``````````````..-:::::::-`  `----------.\n\
......-...-------:----::::::::::::::-.```````````````      `````````````````.....``.-....````  `..``-....:::.````````````````..:::::::::-.  `--------:\n\
.........-------:----:-::::-::::::::.````````````````             ``````````````.......``      ...`.-..--::-.``   ````````````.-:::-::::---.```.------\n\
........-------:-------::---:::::::-.````````````````                        ``` `````       ``.......---:-..``       ````````.-:-::::::::---.```....-\n\
.......-------:-------:---::::::::-..```````````````                          ``````....----:://+++/.-:--:-.``              ```.::::::::::-------.....\n\
......------:--.----:----:::::::::-.```````````````           ``````...--::://+++ooooossssssosssyhyh--:--:-.``               ``.-::::::-:::----------.\n\
.....--------...--:-----::::::::::..``````````````           `/++oosssssssssssssssssssssssooooosyhyh/-:--:-.``               ```-/:::::-:::---------:-\n\
...---------....-------:::-::::::-..````````````      ``     `osssoosssssssssssssssssssssssssoooshyh+-:--:-.``               ```-::::::--------------.\n\
..--------.....--.---:::-:-:::::--..``````````        ```    `+ssoosssssssssssssssssssssssssooooshy/..-.`.-.``               ```.::::-::----.-:-----.-\n\
.--------.`...-..--::----:::::::--..``````            `..`   `/ysosssssssssssssssssssssssssooo+o+/. `.`  .-.``               ``..:::--::---:-`-----.--\n\
-----:-........--::------::--:::--..```                `..````:yyssssssssssssssssssssooooooooo/.   `.`  `--.``               ``..:::-:::----:.`.--.---\n\
---::-.`.....--::------:::-:--::-:..```                `....` `---::://+ossssssssoooooooooooo/`  `.`    `....`              ```..:-::--::-----.`...--.\n\
--:-.`......-:--------:--:-::-::::-.```                `.`    `````.``` `.:osooooooooooooooo/`  ``       `...``             ``..-:-::--::-:----`..---.\n\
::-``....--:---..---:-------:-::::-..``                 `..`          ``    ./ooooooooooooo:`             `..``            ```..-::-::-::-----:-.``.--\n\
-.`....-----....--:---------:--::::..``                 `.....`               .+ooooooooos:`               `..`            ```..-::-:::::-----:..`  `-\n\
.....-::--.....--:----------:::::::-..``                ``.. ``                 :ooooooos+                  ..``          ````...::-::-:::-----.-`    \n";

struct DetectDebugger { bool operator()() { return IsDebuggerPresent(); } };
string flag;


int check_flag(string flag) {
    const char* f = flag.c_str();
    int length,i;
    for(i = 0;i < 0x100;i++) {
        if(!f[i]) {
            break;
        }
    }
    length = i;
    if(length != 57) {
        return 0;
    }
    unsigned char a, r, g, b;
    int width, height;
    struct jpeg_decompress_struct cinfo;
    struct jpeg_error_mgr jerr;

    FILE * infile;        /* source file */
    JSAMPARRAY pJpegBuffer;       /* Output row buffer */
    int row_stride;       /* physical row width in output buffer */
    auto path = DEF_OBFUSCATED("./omake/waifu.jpg");
    string path_str = path.decrypt();
    if ((infile = fopen(path_str.c_str(), "rb")) == NULL) {
        return 0;
    }
    cinfo.err = jpeg_std_error(&jerr);
    jpeg_create_decompress(&cinfo);
    jpeg_stdio_src(&cinfo, infile);
    (void) jpeg_read_header(&cinfo, TRUE);
    (void) jpeg_start_decompress(&cinfo);
    width = cinfo.output_width;
    height = cinfo.output_height;
    unsigned char * pDummy = new unsigned char [width*height*4];
    unsigned char * pTest = pDummy;
    if (!pDummy) {
        return 0;
    }
    row_stride = width * cinfo.output_components;
    pJpegBuffer = (*cinfo.mem->alloc_sarray)
    ((j_common_ptr) &cinfo, JPOOL_IMAGE, row_stride, 1);

    while (cinfo.output_scanline < cinfo.output_height) {
        (void) jpeg_read_scanlines(&cinfo, pJpegBuffer, 1);
        for (int x = 0; x < width; x++) {
            a = 0; // alpha value is not supported on jpg
            r = pJpegBuffer[0][cinfo.output_components * x];
            if (cinfo.output_components > 2) {
                g = pJpegBuffer[0][cinfo.output_components * x + 1];
                b = pJpegBuffer[0][cinfo.output_components * x + 2];
            } else {
                g = r;
                b = r;
            }
            *(pDummy++) = b;
            *(pDummy++) = g;
            *(pDummy++) = r;
            *(pDummy++) = a;
        }
    }
    fclose(infile);
    (void) jpeg_finish_decompress(&cinfo);
    jpeg_destroy_decompress(&cinfo);

    unsigned char* BMap = pTest; 
    int Height = height;
    int Width = width;
    int Depth = 32;
    unsigned char flag_buffer[58];
    for(i = 0;i < 57;i++) {
        flag_buffer[i] = f[i];
    }
    flag_buffer[57] = 0;
    int ptr_current = 0;
    for(i = 0;i < Height * Width * 4;BMap+=2,i+=2) {
        if((*BMap & 1) &&(*(BMap+1) & 1)) {
            flag_buffer[ptr_current] ^= flag_buffer[(ptr_current+1)%57];
        }
        else if((*BMap & 1) && (!(*(BMap+1) & 1))) {
            ptr_current = (ptr_current+1)%57;
        }
        else if((!(*BMap & 1)) && (*(BMap+1) & 1)) {
            ptr_current = (ptr_current-1)%57;
        }
        else {
            flag_buffer[ptr_current]++;
        }
    }
    delete pTest; 
    auto str = DEF_OBFUSCATED("\x65\x7b\xf3\x01\xae\x85\x40\x91\x8a\x0a\xe3\xd5\x4e\x3e\xd3\x58\x50\x52\x9a\x2b\xe2\xf9\x64\x04\xed\x04\x0a\x20\x8f\xa9\xef\x06\xcf\xe3\xaf\x8f\xde\x02\xb4\x83\x58\x3f\xd9\x87\x37\xc0\x10\xc8\x56\x96\x50\x01\x83\xb8\x47\xa9\xb5");
    string buffer_str= (char*)flag_buffer;
    if(str.decrypt() == buffer_str) {
        return 1;
    } else {
        return 0;
    }
}

void real_check() {
    auto ret = OBFUSCATED_CALL_RET(int, check_flag, flag);
    if(ret) {
        cout << OBFUSCATED("おめでとう！\n")  << endl;
    } else {
        cout << OBFUSCATED("残念www\n") << endl;
    }
    exit(0);
}

void real_main() {
    if(fork()) {
        play_music();
        exit(0);
    }
    cout << banner << endl;
    cout << OBFUSCATED("真紅ちゃん天使！\n") << endl;
    cout << OBFUSCATED("flag: ");
    cin >> flag;
    OBFUSCATED_CALL_P0(DetectDebugger, real_check);
    cout << OBFUSCATED("no cheat please") << endl;
}

int main() {
    OBFUSCATED_CALL_P0(DetectDebugger, real_main);
}
